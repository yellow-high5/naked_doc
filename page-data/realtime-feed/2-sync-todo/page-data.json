{"componentChunkName":"component---src-templates-docs-js","path":"/realtime-feed/2-sync-todo","result":{"data":{"site":{"siteMetadata":{"title":"Naked Doc | Simple startup document","docsLocation":"https://github.com/yellow-high5/naked_doc/tree/master/content"}},"mdx":{"fields":{"id":"d536e03a-6177-569b-8385-c5190772d216","title":"Sync new todos","slug":"/realtime-feed/2-sync-todo"},"body":"function _extends() { _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\n\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\n\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n\n/* @jsx mdx */\nvar _frontmatter = {\n  \"title\": \"Sync new todos\",\n  \"metaTitle\": \"Sync new todos in public feed | GraphQL React Apollo Hooks Tutorial\",\n  \"metaDescription\": \"You will learn how to sync new todos added by other people in the public feed by fetching older and newer data using GraphQL Queries\"\n};\n\nvar makeShortcode = function makeShortcode(name) {\n  return function MDXDefaultShortcode(props) {\n    console.warn(\"Component \" + name + \" was not imported, exported, or provided by MDXProvider as global scope\");\n    return mdx(\"div\", props);\n  };\n};\n\nvar layoutProps = {\n  _frontmatter: _frontmatter\n};\nvar MDXLayout = \"wrapper\";\nreturn function MDXContent(_ref) {\n  var components = _ref.components,\n      props = _objectWithoutProperties(_ref, [\"components\"]);\n\n  return mdx(MDXLayout, _extends({}, layoutProps, props, {\n    components: components,\n    mdxType: \"MDXLayout\"\n  }), mdx(\"p\", null, \"Once a new todo is entered in a public list, it needs to appear in the UI. Instead of automatically displaying the todo in the UI, we use a Feed like Notification banner which appears whenever a new todo is received.\"), mdx(\"p\", null, \"Remember that previously we updated the cache using the cache API and the UI got updated automatically, because updating the cache triggered a re-render for those components that were subscribed to this store.\"), mdx(\"p\", null, \"We are not going to use that approach here since we don't want public list UI to be automatically updated.\"), mdx(\"p\", null, \"In the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"TodoPublicListSubscription\"), \" component of the previous step, we only get the latest todo and not the existing list. We will now write a simple query to fetch the list of existing public todos.\"), mdx(\"p\", null, \"Start off by importing \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"useEffect\"), \" from  \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"react\"), \" and \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"useApolloClient\"), \" from \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"@apollo/react-hooks\")), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-javascript\"\n  }), \"- import React, { Fragment } from \\\"react\\\";\\n+ import React, { Fragment, useState, useEffect } from \\\"react\\\";\\n- import { useSubscription } from \\\"@apollo/react-hooks\\\";\\n+ import { useSubscription, useApolloClient } from \\\"@apollo/react-hooks\\\";\\nimport gql from 'graphql-tag';\\n\\nimport TaskItem from \\\"./TaskItem\\\";\\n\")), mdx(\"p\", null, \"Now that we have access to the client, let's update the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"TodoPublicList\"), \" component\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-javascript\"\n  }), \"const TodoPublicList = props => {\\n-    const state = {\\n+    const [state, setState] = useState({\\n-     olderTodosAvailable: true,\\n+     olderTodosAvailable: props.latestTodo ? true : false,\\n-     newTodosCount: 1,\\n+     newTodosCount: 0,\\n      todos: [\\n-       {\\n-         id: \\\"1\\\",\\n-         title: \\\"This is public todo 1\\\",\\n-         user: {\\n-           name: \\\"someUser1\\\"\\n-         }\\n-       },\\n-       {\\n-         id: \\\"2\\\",\\n-         title: \\\"This is public todo 2\\\",\\n-         is_completed: false,\\n-         is_public: true,\\n-         user: {\\n-           name: \\\"someUser2\\\"\\n-         }\\n-       },\\n-       {\\n-         id: \\\"3\\\",\\n-         title: \\\"This is public todo 3\\\",\\n-         user: {\\n-           name: \\\"someUser3\\\"\\n-         }\\n-       },\\n-       {\\n-         id: \\\"4\\\",\\n-         title: \\\"This is public todo 4\\\",\\n-         user: {\\n-           name: \\\"someUser4\\\"\\n-         }\\n-       }\\n      ],\\n+     error: false\\n-   }; \\n+   });\\n\\n+  let numTodos = state.todos.length;\\n+  let oldestTodoId = numTodos\\n+    ? state.todos[numTodos - 1].id\\n+    : props.latestTodo\\n+      ? props.latestTodo.id + 1\\n+      : 0;\\n+  let newestTodoId = numTodos\\n+    ? state.todos[0].id\\n+    : props.latestTodo\\n+      ? props.latestTodo.id\\n+      : 0;\\n+\\n+  const client = useApolloClient();\\n\\n  }\\n\\n  const loadNew = () => {};\\n\\n  const loadOlder = () => {};\\n\\n  ...\\n}\\n\")), mdx(\"p\", null, \"Let's populate initial state by fetching the existing list of todos in \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"useEffect\")), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-javascript\"\n  }), \"const TodoPublicList = props => {\\n  ...\\n\\n  const client = useApolloClient();\\n\\n+  useEffect(() => {\\n+    loadOlder();\\n+  }, []);\\n\\n  const loadNew = () => {};\\n\\n  const loadOlder = () => {}\\n\\n  ...\\n}\\n\")), mdx(\"p\", null, \"Update the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"loadOlder\"), \" method to the following:\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-javascript\"\n  }), \"  const loadOlder = async () => {\\n+    const GET_OLD_PUBLIC_TODOS = gql`\\n+      query getOldPublicTodos ($oldestTodoId: Int!) {\\n+        todos (where: { is_public: { _eq: true}, id: {_lt: $oldestTodoId}}, limit: 7, order_by: { created_at: desc }) {\\n+          id\\n+          title\\n+          created_at\\n+          user {\\n+            name\\n+          }\\n+        }\\n+      }`;\\n+\\n+   const { error, data } = await client.query({\\n+      query: GET_OLD_PUBLIC_TODOS,\\n+      variables: { oldestTodoId: oldestTodoId }\\n+    });\\n+\\n+    if (data.todos.length) {\\n+      setState(prevState => {\\n+        return { ...prevState, todos: [...prevState.todos, ...data.todos] };\\n+      });\\n+      oldestTodoId = data.todos[data.todos.length - 1].id;\\n+    } else {\\n+      setState(prevState => {\\n+        return { ...prevState, olderTodosAvailable: false };\\n+      });\\n+    }\\n+    if (error) {\\n+      console.error(error);\\n+      setState(prevState => {\\n+        return { ...prevState, error: true };\\n+      });\\n+    }\\n+ }\\n\")), mdx(\"p\", null, \"We are defining a query to fetch older public todos and making a \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"client.query\"), \" call to get the data from the database. Once we get the data, we update the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"todos\"), \" state to re-render the UI with the available list of public todos.\"), mdx(\"p\", null, \"Try adding a new todo in the public feed and notice that it will not show up on the UI. Now refresh the page to see the added todo.\"), mdx(\"p\", null, \"This happens because we haven't yet implemented a way to show the newly added todo to the feed.\"), mdx(\"p\", null, \"Let's handle that in \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"useEffect\"), \" for on update\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-javascript\"\n  }), \"  useEffect(() => {\\n    loadOlder();\\n  }, []);\\n\\n+  useEffect(\\n+    () => {\\n+      if (props.latestTodo && props.latestTodo.id > newestTodoId) {\\n+        setState(prevState => {\\n+          return { ...prevState, newTodosCount: prevState.newTodosCount + 1 };\\n+        });\\n+        newestTodoId = props.latestTodo.id;\\n+      }\\n+    },\\n+    [props.latestTodo]\\n+  );\\n\")), mdx(\"p\", null, \"Now try adding a new todo to the public feed and you will see the notification appearing saying that a new task has arrived.\"), mdx(\"p\", null, \"Great! We still have one functionality left. When a new task arrives on the public feed and when the user clicks on the New tasks section, we should make a query to re-fetch the todos that are not present on our current public feed.\"), mdx(\"p\", null, \"Update \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"loadNew()\"), \" method with the following code\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-javascript\"\n  }), \"  const loadNew = async () => {\\n+   const GET_NEW_PUBLIC_TODOS = gql`\\n+     query getNewPublicTodos ($latestVisibleId: Int!) {\\n+       todos(where: { is_public: { _eq: true}, id: {_gt: $latestVisibleId}}, order_by: { created_at: desc }) {\\n+         id\\n+         title\\n+         created_at\\n+         user {\\n+           name\\n+         }\\n+       }\\n+     }\\n+   `;\\n+\\n+   const { error, data } = await client.query({\\n+      query: GET_NEW_PUBLIC_TODOS,\\n+      variables: {\\n+        latestVisibleId: state.todos.length ? state.todos[0].id : null\\n+      }\\n+    });\\n \\n+    if (data) {\\n+      setState(prevState => {\\n+        return {\\n+          ...prevState,\\n+          todos: [...data.todos, ...prevState.todos],\\n+          newTodosCount: 0\\n+        };\\n+      });\\n+      newestTodoId = data.todos[0].id;\\n+    }\\n+    if (error) {\\n+      console.error(error);\\n+      setState(prevState => {\\n+        return { ...prevState, error: true };\\n+      });\\n+    } \\n  }\\n\")));\n}\n;\nMDXContent.isMDXComponent = true;","tableOfContents":{},"parent":{"__typename":"File","relativePath":"realtime-feed/2-sync-todo.md"},"frontmatter":{"metaTitle":"Sync new todos in public feed | GraphQL React Apollo Hooks Tutorial","metaDescription":"You will learn how to sync new todos added by other people in the public feed by fetching older and newer data using GraphQL Queries"}},"allMdx":{"edges":[{"node":{"fields":{"slug":"/apollo-client","title":"Set up a GraphQL client with Apollo"}}},{"node":{"fields":{"slug":"/intro-to-graphql","title":"Intro to GraphQL"}}},{"node":{"fields":{"slug":"/","title":"Landing Page"}}},{"node":{"fields":{"slug":"/queries","title":"Queries"}}},{"node":{"fields":{"slug":"/optimistic-update-mutations","title":"Optimistic UI updates after mutations"}}},{"node":{"fields":{"slug":"/introduction","title":"Course Introduction"}}},{"node":{"fields":{"slug":"/realtime-feed","title":"Realtime Feed"}}},{"node":{"fields":{"slug":"/setup","title":"Tutorial & boilerplate setup"}}},{"node":{"fields":{"slug":"/subscriptions/2-apollo-subscription","title":"Apollo useSubscription React hook"}}},{"node":{"fields":{"slug":"/mutations-variables","title":"Mutations & Query variables"}}},{"node":{"fields":{"slug":"/subscriptions","title":"Subscriptions to show online users"}}},{"node":{"fields":{"slug":"/what-next","title":"What next?"}}},{"node":{"fields":{"slug":"/realtime-feed/2-sync-todo","title":"Sync new todos"}}},{"node":{"fields":{"slug":"/queries/1-fetch-todos-query","title":"Fetch todos - query"}}},{"node":{"fields":{"slug":"/subscriptions/1-subscription","title":"Subscription"}}},{"node":{"fields":{"slug":"/realtime-feed/1-fetch-public","title":"Fetch public todos - subscription"}}},{"node":{"fields":{"slug":"/optimistic-update-mutations/1-update-todos","title":"Update todos - mutation"}}},{"node":{"fields":{"slug":"/queries/3-handle-errors","title":"Handle loading/errors"}}},{"node":{"fields":{"slug":"/optimistic-update-mutations/3-remove-todos","title":"Remove todos - mutation"}}},{"node":{"fields":{"slug":"/optimistic-update-mutations/3.2-bulk-delete-mutation","title":"Bulk delete todos - mutation"}}},{"node":{"fields":{"slug":"/subscriptions/3-create-subscription","title":"Create Subscription and Render Result"}}},{"node":{"fields":{"slug":"/queries/2-create-query","title":"useQuery hook"}}},{"node":{"fields":{"slug":"/optimistic-update-mutations/3.1-mutation-update-cache","title":"Mutation and update cache"}}},{"node":{"fields":{"slug":"/optimistic-update-mutations/2-mutation-cache","title":"Mutation and update cache"}}},{"node":{"fields":{"slug":"/optimistic-update-mutations/3.3-clear-completed","title":"Mutation and update cache"}}},{"node":{"fields":{"slug":"/mutations-variables/2-query-variables","title":"Query Variables"}}},{"node":{"fields":{"slug":"/mutations-variables/3-create-mutation","title":"useMutation Hook, Update Cache"}}},{"node":{"fields":{"slug":"/mutations-variables/1-create-todo","title":"Create todos - mutation"}}},{"node":{"fields":{"slug":"/intro-to-graphql/1-architecture","title":"Architecture"}}},{"node":{"fields":{"slug":"/intro-to-graphql/3-writing-data-mutations","title":"Writing data - Mutations"}}},{"node":{"fields":{"slug":"/intro-to-graphql/2-fetching-data-queries","title":"Fetching data - Queries"}}},{"node":{"fields":{"slug":"/intro-to-graphql/4-watching-data-subscriptions","title":"Watching data - Subscriptions"}}}]}},"pageContext":{"id":"d536e03a-6177-569b-8385-c5190772d216"}}}
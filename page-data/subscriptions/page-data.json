{"componentChunkName":"component---src-templates-docs-tsx","path":"/subscriptions","result":{"data":{"site":{"siteMetadata":{"title":"Naked Doc | Simple startup document","docsLocation":"https://github.com/yellow-high5/naked_doc/tree/master/content"}},"mdx":{"fields":{"id":"beaa0190-4261-56da-a4bf-f79dd12029d9","title":"Subscriptions to show online users","slug":"/subscriptions"},"body":"function _extends() { _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\n\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\n\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n\n/* @jsx mdx */\nvar _frontmatter = {\n  \"title\": \"Subscriptions to show online users\",\n  \"metaTitle\": \"Update last seen of user with Mutation | GraphQL React Apollo Hooks Tutorial\",\n  \"metaDescription\": \"GraphQL Mutation to update last seen of user to make them available online. Use setInterval to trigger mutation every few seconds \"\n};\n\nvar makeShortcode = function makeShortcode(name) {\n  return function MDXDefaultShortcode(props) {\n    console.warn(\"Component \" + name + \" was not imported, exported, or provided by MDXProvider as global scope\");\n    return mdx(\"div\", props);\n  };\n};\n\nvar layoutProps = {\n  _frontmatter: _frontmatter\n};\nvar MDXLayout = \"wrapper\";\nreturn function MDXContent(_ref) {\n  var components = _ref.components,\n      props = _objectWithoutProperties(_ref, [\"components\"]);\n\n  return mdx(MDXLayout, _extends({}, layoutProps, props, {\n    components: components,\n    mdxType: \"MDXLayout\"\n  }), mdx(\"p\", null, \"We cruised through our GraphQL queries and mutations. We queried for todos, added a new todo, updated an existing todo, removed an existing todo.\"), mdx(\"p\", null, \"Now let's get to the exciting part.\"), mdx(\"h2\", null, \"GraphQL Subscriptions\"), mdx(\"p\", null, \"We have a section of UI which displays the list of online users. So far we have made queries to fetch data and display them on the UI. But typically online users data is dynamic.\"), mdx(\"p\", null, \"We can make use of GraphQL Subscription API to get realtime data from the graphql server to efficiently handle this.\"), mdx(\"p\", null, \"But but but...\"), mdx(\"p\", null, \"We need to tell the server that the user who is logged in is online. We have to poll our server to do a mutation which updates the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"last_seen\"), \" timestamp value of the user.\"), mdx(\"p\", null, \"We have to make this change to see yourself online first. Remember that you are already logged in, registered your data in the server, but not updated your \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"last_seen\"), \" value.?\"), mdx(\"p\", null, \"The goal is to update every few seconds from the client that you are online. Ideally you should do this after you have successfully authenticated with Auth0. So let's update some code to handle this.\"), mdx(\"p\", null, \"Open \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"src/components/OnlineUsers/OnlineUsersWrapper.js\"), \" and add the following imports\"), mdx(GithubLink, {\n    link: \"https://github.com/hasura/learn-graphql/blob/master/tutorials/frontend/react-apollo-hooks/app-final/src/components/OnlineUsers/OnlineUsersWrapper.js\",\n    text: \"src/components/OnlineUsers/OnlineUsersWrapper.js\",\n    mdxType: \"GithubLink\"\n  }), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-javascript\"\n  }), \"- import React from \\\"react\\\";\\n+ import React, { useEffect, useState } from \\\"react\\\";\\n+ import { useMutation } from \\\"@apollo/react-hooks\\\";\\n+ import gql from \\\"graphql-tag\\\";\\n\")), mdx(\"p\", null, \"In \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"useEffect\"), \", we will create a \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"setInterval\"), \" to update the last_seen of the user every 30 seconds.\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-javascript\"\n  }), \"const OnlineUsersWrapper = () => {\\n+  const [onlineIndicator, setOnlineIndicator] = useState(0);\\n+  let onlineUsersList;\\n+  useEffect(() => {\\n+     // Every 30s, run a mutation to tell the backend that you're online\\n+     updateLastSeen();\\n+     setOnlineIndicator(setInterval(() => updateLastSeen(), 30000));\\n+\\n+     return () => {\\n+       // Clean up\\n+       clearInterval(onlineIndicator);\\n+     };\\n+ }, []);\\n\")), mdx(\"p\", null, \"Now let's write the definition of the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"updateLastSeen\"), \".\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-javascript\"\n  }), \"const OnlineUsersWrapper = () => {\\n  const [onlineIndicator, setOnlineIndicator] = useState(0);\\n  let onlineUsersList;\\n\\n  useEffect(() => {\\n    // Every 30s, run a mutation to tell the backend that you're online\\n    updateLastSeen();\\n    setOnlineIndicator(setInterval(() => updateLastSeen(), 30000));\\n\\n    return () => {\\n      // Clean up\\n      clearInterval(onlineIndicator);\\n    };\\n  }, []);\\n\\n + const UPDATE_LASTSEEN_MUTATION = gql`\\n +   mutation updateLastSeen($now: timestamptz!) {\\n +     update_users(where: {}, _set: { last_seen: $now }) {\\n +       affected_rows\\n +     }\\n +   }\\n + `;\\n + const [updateLastSeenMutation] = useMutation(UPDATE_LASTSEEN_MUTATION);\\n\\n + const updateLastSeen = () => {\\n +   // Use the apollo client to run a mutation to update the last_seen value\\n +   updateLastSeenMutation({\\n +     variables: { now: new Date().toISOString() }\\n +   });\\n + };\\n\")), mdx(\"p\", null, \"Again, we are making use of \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"useMutation\"), \" React hook to update the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"users\"), \" table of the database.\"), mdx(\"p\", null, \"Great! Now the metadata about whether the user is online will be available in the backend. Let's now do the integration to display realtime data of online users.\"));\n}\n;\nMDXContent.isMDXComponent = true;","tableOfContents":{"items":[{"url":"#graphql-subscriptions","title":"GraphQL Subscriptions"}]},"parent":{"__typename":"File","relativePath":"subscriptions.md"},"frontmatter":{"metaTitle":"Update last seen of user with Mutation | GraphQL React Apollo Hooks Tutorial","metaDescription":"GraphQL Mutation to update last seen of user to make them available online. Use setInterval to trigger mutation every few seconds "}},"allMdx":{"edges":[{"node":{"fields":{"slug":"/","title":"Landing Page"}}},{"node":{"fields":{"slug":"/intro-to-graphql","title":"Intro to GraphQL"}}},{"node":{"fields":{"slug":"/introduction","title":"Course Introduction"}}},{"node":{"fields":{"slug":"/queries","title":"Queries"}}},{"node":{"fields":{"slug":"/apollo-client","title":"Set up a GraphQL client with Apollo"}}},{"node":{"fields":{"slug":"/mutations-variables","title":"Mutations & Query variables"}}},{"node":{"fields":{"slug":"/realtime-feed","title":"Realtime Feed"}}},{"node":{"fields":{"slug":"/setup","title":"Tutorial & boilerplate setup"}}},{"node":{"fields":{"slug":"/subscriptions/2-apollo-subscription","title":"Apollo useSubscription React hook"}}},{"node":{"fields":{"slug":"/optimistic-update-mutations","title":"Optimistic UI updates after mutations"}}},{"node":{"fields":{"slug":"/subscriptions","title":"Subscriptions to show online users"}}},{"node":{"fields":{"slug":"/subscriptions/3-create-subscription","title":"Create Subscription and Render Result"}}},{"node":{"fields":{"slug":"/subscriptions/1-subscription","title":"Subscription"}}},{"node":{"fields":{"slug":"/realtime-feed/1-fetch-public","title":"Fetch public todos - subscription"}}},{"node":{"fields":{"slug":"/realtime-feed/2-sync-todo","title":"Sync new todos"}}},{"node":{"fields":{"slug":"/queries/1-fetch-todos-query","title":"Fetch todos - query"}}},{"node":{"fields":{"slug":"/queries/2-create-query","title":"useQuery hook"}}},{"node":{"fields":{"slug":"/optimistic-update-mutations/1-update-todos","title":"Update todos - mutation"}}},{"node":{"fields":{"slug":"/what-next","title":"What next?"}}},{"node":{"fields":{"slug":"/queries/3-handle-errors","title":"Handle loading/errors"}}},{"node":{"fields":{"slug":"/optimistic-update-mutations/2-mutation-cache","title":"Mutation and update cache"}}},{"node":{"fields":{"slug":"/optimistic-update-mutations/3.2-bulk-delete-mutation","title":"Bulk delete todos - mutation"}}},{"node":{"fields":{"slug":"/optimistic-update-mutations/3.1-mutation-update-cache","title":"Mutation and update cache"}}},{"node":{"fields":{"slug":"/optimistic-update-mutations/3-remove-todos","title":"Remove todos - mutation"}}},{"node":{"fields":{"slug":"/optimistic-update-mutations/3.3-clear-completed","title":"Mutation and update cache"}}},{"node":{"fields":{"slug":"/mutations-variables/2-query-variables","title":"Query Variables"}}},{"node":{"fields":{"slug":"/mutations-variables/1-create-todo","title":"Create todos - mutation"}}},{"node":{"fields":{"slug":"/mutations-variables/3-create-mutation","title":"useMutation Hook, Update Cache"}}},{"node":{"fields":{"slug":"/intro-to-graphql/1-architecture","title":"Architecture"}}},{"node":{"fields":{"slug":"/intro-to-graphql/2-fetching-data-queries","title":"Fetching data - Queries"}}},{"node":{"fields":{"slug":"/intro-to-graphql/3-writing-data-mutations","title":"Writing data - Mutations"}}},{"node":{"fields":{"slug":"/intro-to-graphql/4-watching-data-subscriptions","title":"Watching data - Subscriptions"}}}]}},"pageContext":{"id":"beaa0190-4261-56da-a4bf-f79dd12029d9"}}}